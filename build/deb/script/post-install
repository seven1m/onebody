#!/bin/bash

set -e

onebody config | grep SERVE_ASSETS &>/dev/null || onebody config:set SERVE_ASSETS=true
onebody config | grep PORT=6000    &>/dev/null && onebody config:set PORT=3000

if [[ ! -e /etc/onebody/database.yml ]]; then
  echo "Building /etc/onebody/database.yml"
  echo -e "production:\n  adapter: mysql2\n  database: onebody\n  host: localhost\n  username: onebody\n  password: onebody\n  encoding: utf8" > /opt/onebody/config/database.yml
  ln -sf /opt/onebody/config/database.yml /etc/onebody/database.yml 
  chown onebody:onebody /etc/onebody/database.yml
fi

if [[ ! -e /etc/onebody/secrets.yml ]]; then
  echo "Building /etc/onebody/secrets.yml"
  cp /opt/onebody/config/secrets.yml{.example,}
  secret=$(onebody run rake secret)
  sed -i "s/SOMETHING_RANDOM_HERE/$secret/" /opt/onebody/config/secrets.yml
  ln -sf /opt/onebody/config/secrets.yml /etc/onebody/secrets.yml 
  chown onebody:onebody /etc/onebody/secrets.yml
fi

echo "Checking database state"

onebody run rake db:version &>/dev/null && exists=true || exists=false
if [[ $exists == true ]]; then
  echo "Updating database"
  onebody run rake db:migrate
  systemctl restart onebody
else
  echo
  echo "To create the OneBody database, run the following commands manually:"
  echo
  echo "  mysql -u root -p -e \"grant all on onebody.* to onebody@localhost identified by 'onebody';\""
  echo "  onebody run rake db:setup"
  echo
  echo "Next, create and start the OneBody web service with the following commands:"
  echo
  echo "  onebody scale web=2"
  echo "  systemctl start onebody"
  echo "  (or 'service onebody start' on Ubuntu 14.04)"
  echo
  echo "Last, you'll need to set up a web server to proxy requests to OneBody."
  echo "Here's how to do it with nginx:"
  echo
  echo "  apt-get install nginx"
  echo "  nano /etc/nginx/sites-available/onebody"
  echo
  echo "Paste the following config and save the file:"
  echo
  echo "  upstream onebody {"
  echo "      server 127.0.0.1:3000;"
  echo "      server 127.0.0.1:3001;"
  echo "  }"
  echo "  server {"
  echo "      listen 80;"
  echo "      client_max_body_size 25m;"
  echo "      location / {"
  echo "          proxy_pass http://onebody;"
  echo "      }"
  echo "  }"
  echo
  echo "Finally, run the following to start the site in nginx:"
  echo
  echo "  ln -s /etc/nginx/sites-{available,enabled}/onebody"
  echo "  rm /etc/nginx/sites-enabled/default"
  echo "  nginx -s reload"
  echo
  echo "You're done! Your site should be available by visiting the IP address"
  echo "of this server!"
  echo
fi
